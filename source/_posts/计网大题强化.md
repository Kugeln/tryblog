---
title: 计网大题强化
date: 2025-06-24 21:37:22
tags: 408日常
sticky: 272
banner_img: /img/1920x1080 (41).jpg
index_img: /img/1920x1080 (41).jpg
---

* 真题应反复多做，千万别舍不得
* 真题的抹开分数无法代表任何东西，别自负、更别自卑
* 计网真题要分类做，更能感受命题规律
* 计网真题每年只有8道真题、1道大题，全部真题分类二刷一遍，8~10天足矣

## 计算机网络各种协议

![](/img/jisuanjiwangluoxieyi.png)

![](/img/jiwangxieyi.png)

* 数据链路层
  * PPP协议，点对点协议
  * CSMA协议
    * 1-坚持
      * 一直看路，路空就走
    * 非坚持
      *  路没空低头看手机，随机一段时间再抬头看
    * p-坚持
      * 一直看路，路空有概率走也有概率不走
  * CSMA/CD协议，有线局域网
    * 走前先看路，走的时候一直看，要撞了就回去，随机一段时间再出发
  * CSMA/CA协议，无线局域网
    * 走前看路，路空等一段时间还是空就出发，撞了就回退并开始计时，空闲就继续倒计时，倒计时为0重新出发
  * ALOHA协议，随机访问介质访问控制协议/争用型协议
    * 人和车随时可以通行，相撞后等待一段随机的时间进行重传
  * 时隙ALOHA协议，随机访问介质访问控制协议/争用型协议
    * 每个时间段开始的时候人或车才能走，撞了以后等一段时间
  * 网络适配器
  * HDLC协议

* 网络层
  * IP协议
  * ICMP协议
  * ARP协议
  * RARP（逆地址解析协议）
  * SDN
  * Traceroute/Tracert
  * IGP内部网关协议
    * OSPF，直接用IP数据报
  * IGMP（网际组管理协议），封装在IP数据报中传送

* 传输层
  * TCP协议
  * NAT
  * UDP协议

* 应用层
  * EGP外部网关协议
    * BGP-4，基于TCP
  * RIP
    * 路由信息协议
    * 分布式的基于距离向量的路由选择协议
    * 基于UDP
  * FTP协议
    * 文件传送
    * 基于TCP
  * DHCP协议
    * 基于UDP
    * ip地址分配
  * PING，直接使用网络层的ICMP
  * 移动ip归属代理代理功能的实现
  * DNS
    * 基于UDP
    * 域名解析
  * TFTP
    * 简单文件传送协议
    * 基于UDP
  * SNMP
    * 简单网络管理协议
    * 基于UDP
  * SMTP
    * 简单邮件传送协议
    * 基于TCP
  * TELNET
    * 远程终端协议，远程终端接入
    * 基于TCP
  * HTTP
    * 超文本传送协议
    * 万维网
    * 基于TCP
    * 本身是无连接的，虽然http使用了tcp链接，但通信的双方在交换http报文之前不需要先建立http链接
  * 使用客户/服务器模型
    * Web
    * FTP文件传输协议
    * 远程登录
    * 电子邮件
  * 电子邮件协议
    * SMTP
      * 邮件发送协议
    * POP3
      * 邮件读取协议
      * 基于TCP
    * IMAP

## 概述

![](/img/jhndgbfdv.png)

![](/img/vervrev.png)

* **通常就是选择题第一题 2分**

* OSI参考模型
  * 主考记忆
  * 层次顺序，各层关系
    * 物、链、网、输、会、示、用
  * 各层功能
* TCP/IP模型
  * 各层协议之间的关系

### OSI和TCP/IP模型梳理

* OSI（记忆、各层关系、功能）

  * OSI参考模型中，网络层采用**虚电路**连接

    * 提供可靠有序的虚电路服务，支持无连接和面向链接的通信
      * 虚电路不需要预分配带宽
      * OSI参考模型中路由器的路由表会记录虚电路号(VCID)和下一跳地址
    * 虚电路服务在两台主机开始正式传输之前，需要通过OSI的第三层网络层去建立一个虚电路，这条虚电路会对应一个VCID虚电路号
      * 虚电路在建立的时候需要进行路由选择规划道路，建立后转发路径不发生改变
      * 当左边这台主机发出自己的IP数据报或者说IP分组的时候，只需要指明自己要发的这个IP分组的VCID，即通过哪一条虚电路进行转发
      * 当分组或者数据报经过A主机的时候，A主机这边会记录一个表，表包括VCID和下一跳
        * 不会检查IP数据报里的目的地址，检查的是虚电路号，然后通过虚电路号找到下一跳

    ![](/img/110114.jpg)

    ![](/img/111433.jpg)

    ![](/img/11653.jpg)

    ![](/img/111729.jpg)

  * 设计者认为应该由**网络层提供可靠、有序的传输服务**

  * 会话层和表示层的功能和位置

    * 会话层
      * 会话管理（**断点重传**）
        * 传文件传到一半，断了，重新连接之后可以断点重传
    * 表示层
      * 编码
        * 不同主机上对于各种字符信息的编码显示可能不一样，表示层解决**各个主机编码不一样**的问题
      * 数据格式转换

  * **网络层**实现的是**主机到主机**之间的传输

    * **传输层**实现的是**端到端（进程到进程）**之间的传输
    * **数据链路层**实现的是**相邻结点**之间的传输

* TCP/IP（各种协议之间的关系）

  ![](/img/87i574.png)

  * 数据链路层&物理层协议（网络接口层）
    * 802.3CSMA/CD
      * 以太网
    * 802.11CSMA/CA
      * 无线局域网
    * 802.5令牌传递协议
  * 网络层
    * ARP
      * 需要使用链路层的某一个协议去服务
    * IP
      * 可以使用链路层的某一个协议去服务
        * 当我们说一个协议为另一个协议服务的时候，本质上是我们再强调**这个协议的服务数据单元（SDU）携带的是被服务协议的协议数据单元（PDU）**
  * 传输层
    * TCP
      * 使用IP协议
    * UDP
      * 使用IP协议
      * **无连接服务**
  * 应用层
    * SMTP/POP3（电子邮件）
      * 使用TCP
    * HTTP（浏览网页）
      * 使用TCP
    * DNS
      * 使用UDP
    * DHCP（动态主机配置获得IP地址）
      * 使用UDP
    * FTP（文件传输）
      * 使用TCP

## 物理层

![](/img/,umjhngfd.png)

![](/img/bu564v534cx3.png)

* 选择题

* **模拟信号**

  * **调制**

    ![](/img/647nb3.png)

    ![](/img/56b4v.png)

    * ASK
      * 调幅AM
      * 幅度
      * 4种幅度可以表示2bit
    * FSK
      * 调频FM
      * 频率
      * 8种振幅意味着3bit
    * PSK
      * 调相PM
      * 相位
      * 8种相位意味着4bit
    * QMA
      * 正交幅度调制
      * QAM-16意味着总共有16种信号，4bit

  * 香农

    * **有噪声信道**上，极限**比特率**（数据传输速率）=Wlog2（1+S/N)   b/s
      * W是带宽（单位为hz）
      * S是信道内所传输信号的平均功率
      * N为信道内的高斯噪声功率
      * S/N为信噪比，无单位记法时信噪比=S/N，采用分贝记忆法时，信噪比=10log10（S/N）

  * 奈氏

    * **无噪声信道**上，极限**波特率**=2W（以**Hz**为单位的**带宽**）
    * 极限**数据传输速率（比特率）**=2Wlog2V b/s（V是一个码元的离散电平数量）

  * 码元、bit的关系

    * **每个周期的信号对应一种码元，而一个码元能携带多少个bit就得看一个周期内的信号有多少种**

  * 波特率

    * 每秒传输的**码元数**

  * 比特率

    * 每秒传输的**bit数**

* **数字信号** 波形

  * **编码**

  ![](/img/7n46b.png)

  ![](/img/68m57.png)

  ![](/img/9m789n.png)

## 数据链路层

![](/img/98kujrytb.png)

* 选择题

  * **CSMA/CA**

    ![](/img/7n85.png)

    * 画图（预约信道）

    ![](/img/ury.png)

    ![](/img/wevr.png)

    * 三个地址

    ![](/img/Q232C2.png)

    ![](/img/5-06-25 141537.jpg)

    * **无线**通信当中，**无线局域网**使用
      * 手机和路由器

  * **CSMA/CD**

    * **以太网**（**最短帧长**）

    * **冲突检测（边发边检；冲突停发）**

      ![](/img/h4q.png)

      * 节点间的最长距离（距离是题目变量）
        * ①计算出最短的帧的发送时间
        * ②根据**最短帧发送时间大于等于两倍单向传播时间**
        * ③结合信号在信道上的**传播速度**，计算出信道的最长距离等于多少
      * 距离固定，冲突检测的**最短**或者**最长**时间
        * 最短帧长和传输速率，就可以计算出发出一个最短的帧需要多长时间
        * **发出一个帧最短所需要的时间不能小于二倍的单向传播时延**
        * 计算出上述条件之后，再结合信号的传播时间、信号的传播速度，就可以得知节点之间的**最长的距离**等于多少

* 大题：通常结合高层协议考察

  * 链路层MAC帧通常会和高层协议结合起来考察（**如何封装成帧**）

  * ARP

    ![](/img/twrh.png)

    ![](/img/qcewcew.png)

    * 要能从空ARP表开始分析
    * **广播找人，单播回应**
    * 网络层协议，定义了ARP分组，和IP分组是两个独立的东西，是单独的数据结构
    * 会被封装到链路层MAC帧里面，最终要实现地址解析，要通过几个ARP分组的传输，找到一个IP地址对应的MAC地址等于多少
    * 如果一台主机要发送一个IP分组给另一台主机，但是**另一台主机刚好与自己从属于从一个局域网**，这种情况下**需要把IP分组封装成一个MAC帧**。MAC帧当中应该直接指明与我从属于同一个局域网的那个目的主机，它的MAC地址等于多少
    * 如果一台主机要发送的目的主机并不在本网络内，那么此时发送方得把这个IP数据报发送给**默认网关**，默认网关也有一个MAC地址，所以这个IP数据报发送给默认网关的时候，也需要把**目的MAC地址填写为默认网关的MAC地址**
    * 也就是说，当我构造一个IP数据报的时候，一旦确定了目的IP地址，那么如果**目的IP地址直接就是和我在同一个网络**，那就需要**用ARP协议查到目的IP地址对应的MAC地址** 
    * 运行只需要发出一个ARP分组（请求），被查询的一方回复一个ARP响应分组,ARP协议的工作就完成了
    * 每一台主机内部都有一张ARP表，记录了**自己已经查询到的IP地址和MAC地址之间的映射关系**
    * ARP分组里面必须指明**想要找的主机的IP地址，我的IP地址，我的MAC地址**，之后**MAC帧的目的地址全1（广播）**
    * 想要找的主机收到ARP请求分组之后，会构造一个ARP相应分组返回给“我“
      * 内容包括**被查询主机的MAC地址和IP地址**
      * 不需要广播，直接单播
    * 收到ARP响应分组之后，会把收到的**IP地址和MAC地址之间的映射关系**记录到ARP表中

  * IP

    ![](/img/y4n.png)

    ![](/img/5vc3.png)

    ![](/img/n5nb6b.png)

    ![](/img/675b5v4.png)

    ![](/img/trvev.png)

    * 太长

      * 分片问题

        * 最长1500B（MTU最大传输单元）
        * 418首总偏
          * 偏移量表示的是每个IP数据包当中，它携带的数据**在原始IP数据报当中的位置**
          * **偏移量必须是8字节的整数倍，最后一个分片除外**
        * 每一个分片都有自己的IP首部，而首部当中都包含418首总偏这几个字段
        * 还有MF（是否还有其他分片）DF（是否允许分片）
          * 如果链路层无力承担大的IP数据报，但是原IP数据报的DF又=1，此时只能把IP数据报丢掉，再通过一个ICMP报文告诉发送IP数据报的源节点，IP数据报已经被丢掉，发生了异常
            * ICMP协议本质就是网络当中的异常通知机制

      * 例子

        ![](/img/61259.jpg)

        * 假设IP数据报首部20B，数据2000B，假设其链路层的MTU=800
          * DF字段的值取决于源IP数据报
          * 第一个分片
            * MF=1，DF=0
            * 首部20B，总长度796B，偏移量0
          * 第二个分片
            * MF=1，DF=0
            * 首部20B，总长度796B，偏移量97
          * 第二个分片
            * MF=0，DF=0
            * 首部20B，总长度468B，偏移量194

    * 太短

      * 填充问题
      * 不能小于46字节
      * 路由器收到IP数据包的时候如何区分这个IP数据报真实的数据是多少？
        * 418首（首部长度）总（总长度）偏（偏移量）

    * 路由器转发后帧的地址变换

  * DHCP（**参考海投简历找工作流程**）

    ![](/img/uytres.png)

    ![](/img/0888io.png)

    ![](/img/wxewxww.png)

    * 要能分析DHCP全过程，**每个报文被如何封装**
    * **四个DHCP报文的目的MAC地址和源MAC地址如何配置**
      * 假设H3新加入网络
        * ①刚接入网络的时候，没有被分配IP地址，需要跟**本网络的DHCP服务器**发生通信，请求DHCP服务器给自己分配一个**IP地址及配置默认网关、配置子网掩码**
          * H3天生携带的只有**MAC地址**
        * ②涉及四个报文
          * **第一**个报文**发现报文**
            * 说明自己的**MAC地址**
            * 在链路层会被封装成**MAC帧**
              * **目的MAC地址**是**广播地址**，**48bit全1**
                * 因为h3刚加入网络不知道DHCP服务器的MAC地址是多少
                * 因此DHCP发现报文**会被整个网络内所有的节点收到，但是应用层只有DHCP服务器接收**
              * **源MAC地址**是自己的MAC地址
          * **第二**个报文**提供报文**
            * 提供**IP地址、子网掩码、默认网关**
            * **单播帧**
              * **目的MAC**是**新加入的主机MAC地址**
              * **源MAC**是**DHCP服务器的MAC地址**
          * **第三**个报文**请求报文**
            * 在一个局域网内部可能会有很多台DHCP服务器
              * 也就是说H3发出第一个DHCP发现报文的时候，网络内所有的DHCP服务器都会收到，每一台都会以为这个节点在跟自己索要IP地址。
              * 因此H3可能被多个DHCP服务器分配IP地址
              * 因此H3需要发送请求报文向**网络内所有DHCP服务器告知自己的IP地址是哪个DHCP服务器分配的**
              * 因此请求报文的**目的MAC是广播地址**
            * **广播帧**
          * **第四**个报文**确认报文**
            * 确认H3的IP地址是该DHCP服务器分配的
            * **单播帧**
    * **IP地址如何分配**
      * ①**发现报文**
        * 刚开始没有IP地址，因此**源IP地址全0**
        * 刚加入不知道DHCP服务器的IP地址，**目的IP地址为广播地址，全1**
      * ②**提供报文**
        * **目的IP地址广播地址**，因为H3目前还没有IP地址，为了**防止H3的网络层过滤掉这个IP数据报**，应该用广播IP去告诉H3应该接收
          * 因为每台主机的网络层都会检查目的IP地址是多少，如果**目的IP地址和自己的IP地址相同或者是广播地址**，这些主机才会接收这个IP数据报
        * **源IP地址是DHCP服务器自己的**
      * ③**请求报文**
        * 因为尚未确定IP地址，所以**源IP地址依旧是全0**
        * 因为有多个DHCP服务器，H3要告诉所有分配IP的DHCP服务器，最终自己接收了哪个DHCP服务器发来的IP地址，因此**目的IP是广播IP**，以防DHCP服务器的网络层把这个IP数据报过滤掉
      * ④**确认报文**
        * H3还没有真正确定自己的IP地址，因此**目的IP地址仍然是广播IP**，这样才能确保H3的网络层不要把这个IP数据报过滤掉

## 王道基础课网络层内容

### 网络层的功能

![](/img/pipocw.png)

* 在五层协议模型中处于**第三层**，为**传输层**提供服务
* **应用层**的传输单位是**报文**
  * 应用层，把报文交给传输层之后，**传输层会把报文拆分成报文段**
  * 紧接着传输层又把报文段交给网络层，让网络层进行传输。**网络层会在报文段的基础之上加一个首部**，我们把它称为**IP数据报的首部**。那这样的一整块数据就是所谓的IP数据报。也就是我们之前经常提到的分组。**IP数据报和IP分组在408计网里面是等价的**
* 网络层实现了**主机到主机**的传输
* 数据链路层实现了**相邻结点**之间的传输

![](/img/eqgqrg.png)

![](/img/eagrg.png)

* **路由器也被称为网关**
* 路由器根据**路由协议**，生成**自己的路由表**，然后根据路由表规划**IP数据报（分组）的最佳转发路径**

![](/img/qcqqcq.png)

### IPv4

![](/img/h54h456.png)

* ARP协议，ICMP协议和IGMP协议的**数据会被封装在IP分组当中**

![](/img/w45nwn5q4q.png)

#### IP数据报（IP分组）的格式

![](/img/b56b56b6.png)

* **首部一定有20B的固定内容**
* **首部长度以X4B为单位**，也就是假如首部有20B，那么首部长度就是5，所以**整个首部的最大长度是15*4B=60B**
* 填充是为了**凑足4B的整数倍**
* **总长度包含首部和数据部分**

![](/img/452vv2.png)

* **标识**字段表示**分片来自哪个完整IP数据报**
* **片偏移以8B为单位**

![](/img/e56n.png)

* **只校验IP数据报首部**

![](/img/w45nwn.png)

#### IP数据报的生存时间TTL

![](/img/w45bw4b5n.png)

![](/img/65eb3.png)

* 到达一个路由器，路由器会将TTL-1，**若在某一个路由器TTL变成0，则该路由器不会将这个IP数据报转发出去**，会丢弃该IP数据报，然后路由器给源主机发送ICMP报文

#### IP数据报的“分片”问题

![](/img/qb3b.png)

![](/img/qb43qb6n.png)

![](/img/65n6nn.png)

![](/img/w4s5.png)

* 以太网MAC帧的46-1500就是IP数据报的大小
* **一个链路层数据帧能承载的最大数据量称为最大传送单元（MTU）**，以太网的MTU=**1500B**
* 每个分片又是独立的IP数据报

### IP地址

* IP地址发展顺序
  * ABCDE类👉子网划分👉CIDR👉NAT

![](/img/vvvvv.png)

* 单播地址分配给某一台主机
* 多播地址为了实现**IP多播**，即把IP分组发给**从属于同一个多播地址的一系列主机**

![](/img/45v4v5.png)

* IP地址为了方便阅读，会记录成**十进制的形式，8bit一组对应一个十进制数，32bit的IP地址有4个十进制数**
* 因为8bit对应一个十进制数，8bit能表示的数值范围是**0~255**
* **默认网关就是默认路由器**，即每一台主机接入互联网的时候需要经过哪一台路由器的转发，需要把**和它连接的这台路由器的接口的IP地址配置为默认网关**。
  * 这样当一台主机要往互联网上发送一个IP数据报的时候，就知道**IP数据报应该先发给默认网关**，然后路由器就会把IP数据报转发到互联网上

#### 例子

![](/img/weffwef.png)

* 某一个网络里面所有主机的网络号相同，网络内部各台主机的主机号可以由网络管理员自由分配

* **路由器和其他节点连接的接口必须分配IP地址**

* 路由器会从**IP数据报首部目的地址段拆分出网络号**，然后根据路由转发表进行转发

* H1向H7发送IP数据报的过程：

  ![](/img/xxcvvadf.png)

  * ①h1知道默认网关的IP地址之后，通过ARP协议查询到默认网关的MAC地址，将MAC帧的目的MAC地址写成B2接口的MAC地址。然后H1把MAC帧发送给交换机
  * ②交换机根据MAC帧的目的地址转发到路由器的B2接口
  * ③路由器收到IP数据报之后，检查目的网络的IP地址，根据路由器转发表从某个接口转发出去。
    * 转发的时候要修改MAC帧的目的地址为转发目的接口的MAC地址
  * ④目的路由器收到IP数据报，检查IP数据报的目的地址，根据路由器转发表找到对应接口进行转发，并对MAC帧的目的地址进行修改
    * MAC地址由ARP协议得出
    * ARP协议的作用就是让同一个网络的主机和路由器之间，**查询到IP地址对应的MAC地址**
  * **IP数据报的源地址和目的地址没变，但是MAC的目的地址和源地址一直在变**

* H1向H6发送IP数据报的过程：

  ![](/img/ffffdsfawef.png)

  * ①H1检查目的网络的IP地址，发现**从属于从一个网络，不用发给默认网关**，通过ARP协议查询到H6的MAC地址，直接把数据报封装成MAC帧，通过交换机（直接）和集线器（广播）发送给H6

#### 一些特殊用途的IP地址

![](/img/wefffff.png)

![](/img/xxcvvadf.png)

* 向网络号为Y的网络广播IP分组

![](/img/fffffffsdf.png)

* 表示本网络中主机号为Y的主机

![](/img/ffffdsfawef.png)

* 向本网络广播IP分组

![](/img/weffwaf.png)

* DHCP协议请求分配IP地址

![](/img/wccwcwcw.png)

* 不会发送到网络上，从H1网络层发出然后H1自己接收

#### 子网划分和子网掩码

![](/img/vweqvvqv.png)

* 路由器的一个接口对应的就是一个独立的网络
* 作用：**把一整块很大的IP地址块拆分成两个更小的部分**
* 引入子网之后，一台主机除了IP地址和默认网关之外，还要配置子网掩码（十进制记录）
  * 17位1，对应的是网络号和子网号总bit数，15位0，对应主机号
  * **用子网掩码和IP地址进行逐位与运算得到网络号和子网号部分（网络前缀）**
* 子网掩码的作用：判断是否属于同一个网络，不能只考虑网络号，还要考虑子网号，**只有网络号和子网号完全相同的两个IP地址才属于同一个子网**

![](/img/cwavew.png)

* 想要更多子网，就在主机号中抠出更多位数作为子网号

![](/img/waevb.png)

* 划分成多个子网以后，可以增加多个路由器，再由一个总路由器和外部连接
  * 好处：如果只有一个总路由器，不同子网主机之间的IP数据报都需要总路由器进行转发，**负担较大**，多个路由器能够减少总路由器的压力

##### 画图训练

![](/img/ewrwer.png)

###### 同一子网内部发送IP数据报

![](/img/weffwfafe.png)

* ①源地址：H3ip地址，目的地址：H6ip地址，h3检查目的地址和自己是否从属于从一个网络
  * 用配置的子网掩码和目的地址以及源地址逐位与
* ②**在同一个网络内，H3把IP数据报封装成MAC帧**，并**在MAC帧当中直接说明H6的MAC地址**
* ③MAC帧通过交换机到达集线器，集线器会把指责个MAC帧无脑转发给H5和H6，H5不会接受这个MAC帧因为地址不一样。由于IP地址匹配，H6会接收这个MAC帧，然后拆掉MAC帧的首部和尾部，得到IP数据报。

###### 不同子网同一个路由器之间发送IP数据报

![](/img\vvvvsadf.png)

* ①源地址：H1ip地址，目的地址：H3ip地址，h1检查目的地址和自己是否从属于从一个网络
  * 用配置的子网掩码和目的地址以及源地址逐位与
* ②两者网络前缀不相等，说明不在同一个网络，H1需要把IP数据报发送给默认网关
* ③H1根据ARP协议知道默认网关的MAC地址，把IP数据报封装成MAC帧，目的地址是默认网关对应接口的MAC地址
* ④MAC帧经过交换机交给路由器，路由器的数据链路层把帧的首部尾部控制信息拆除之后，再把IP数据报交给路由器的网络层
* ⑤路由器的网络层用目的地址和路由转发表中的每一个表项对比
  * **先和子网验码逐位与，相与的结果再和目的网络号进行比较**
* ⑥IP数据报封装成帧转发出去，交换机根据MAC地址转交给H3

###### 不同网络不同路由器，一个子网一个非子网发送IP数据报

![](/img/32v3.png)

* ①源地址：H1ip地址，目的地址：H7ip地址，h1检查目的地址和自己是否从属于从一个网络
  * 用配置的子网掩码和目的地址以及源地址逐位与
* ②两者网络前缀不相等，说明不在同一个网络，H1需要把IP数据报发送给默认网关
* ③H1根据ARP协议知道默认网关的MAC地址，把IP数据报封装成MAC帧，目的地址是默认网关对应接口的MAC地址
* ④MAC帧经过交换机交给路由器，路由器的数据链路层把帧的首部尾部控制信息拆除之后，再把IP数据报交给路由器的网络层
* ⑤路由器的网络层用目的地址和路由转发表中的每一个表项对比
  * **先和子网验码逐位与，相与的结果再和目的网络号进行比较**
  * **对于没有子网划分的网络来说，可以给这种网络配置一个默认子网掩码，1的位数规则和有子网划分的一样**
* ⑥IP数据报封装成帧转发出去，转发给下一个路由器
* ⑦传统路由器根据目的IP地址的前几个bit判断到底是A、B、C、D、E哪类地址，然后根据不同类别取出对应网络号的bit数，然后主机号全部置为0。取出网络号之后再和转发表的表项进行对比。
* ⑧找到对应接口，逐层转发到H7

![](/img/c213.png)

* ①H7封装IP数据报，检查是否从属于同一个网络，因为不是从属于同一个网络，H7需要把它封装成帧，发给默认网关。
  * 没有进行子网划分的网络。所以H7不需要去管什么子网掩码，那些东西由于自己属于c类网络。所以就需要用自己的前24比特IP地址的前24比特和这个目的地址的前24比特进行对比。对比失败，那么说明这个目的地址和自己并不在同一个网络之内。
* ②路由器检查目的IP，属于B类网络，查看目的地址前16bit，主机号置0，与转发表的表项对比，从某个接口转发出去
* ③到达有子网划分的路由器，该路由器首先用目的IP地址和每一行进行对比
  * **先和子网验码逐位与，相与的结果再和目的网络号进行比较**
  * **对于没有子网划分的网络来说，可以给这种网络配置一个默认子网掩码，1的位数规则和有子网划分的一样**
* ④匹配成功，从某个接口转发出去
  * 由于转发接口的IP地址和目的IP地址属于同一个网络，所以**这个路由器把IP数据报封装成帧的时候，就可以直接把MAC帧的目的地址写为H1的MAC地址**

###### 发送到互联网

![](/img/3ax.png)

* ①H1构造IP数据报，源地址：H1的IP地址，目的地址：目的IP地址。检查目的地址和自己是否从属于从一个网络
  * 用配置的子网掩码和目的地址以及源地址逐位与
* ②两者网络前缀不相等，说明不在同一个网络，H1需要把IP数据报发送给默认网关
* ③H1根据ARP协议知道默认网关的MAC地址，把IP数据报封装成MAC帧，目的地址是默认网关对应接口的MAC地址
* ④MAC帧经过交换机交给路由器，路由器的数据链路层把帧的首部尾部控制信息拆除之后，再把IP数据报交给路由器的网络层
* ⑤路由器的网络层用目的地址和路由转发表中的每一个表项对比
  * **先和子网验码逐位与，相与的结果再和目的网络号进行比较**
  * **对于没有子网划分的网络来说，可以给这种网络配置一个默认子网掩码，1的位数规则和有子网划分的一样**
  * **如果目的IP地址和配置的除默认路由外所有行都对不上，则转发给默认路由对应接口**
* ⑥IP数据报封装成帧转发出去，转发给下一个路由器。传统老路由器检查网络号，发现属于A类网络，取出前8bit网络号，末尾24位置0，然后和转发表对比，**如果都对比不上，从“其他“的转发接口发出**，路由器封装成帧发给下一跳
* ⑦重复上述过程逐一转发，最终到达目的主机

##### 大题分析思路

![](/img/erhehra.png)

![](/img/wceaceea.png)

![](/img/awecrve.png)

* 什么时候会发生匹配的“转发接口”和IP数据报的入口相同？
  * H1要给H2发送一个IP数据报，H1发送的时候误将IP数据报封装成了一个广播帧，到达B3的时候路由器根据目的IP地址查表，发现转发接口刚好是B3，出口和入口相同，因此路由器不用把这个IP数据报重新转发回去了，**直接丢弃即可**

##### 子网掩码的CIDR记法

![](/img/wqevewqb.png)

* xxx.xxx.xxx.xxx/n，**代表这台主机配置的子网掩码前n个bit全是1，后面的bit全是0**
* /n是某台主机内部子网掩码配置，构造IP数据报的时候不需要加这个后缀也没地方加

#### 无分类编址CIDR

![](/img/45vv45vv.png)

##### 定长子网划分和变长子网划分

![](/img/bwbretb.png)

* 定长子网划分的缺陷

![](/img/tynwee.png)

###### 例1：无分类编制CIDR、变长子网划分的应用

![](/img/23132b3.png)

###### 例2：无分类编址CIDR、变长子网划分的应用

![](/img/433h23.png)

![](/img/2c3v2.png)

* 需保证**任何一个子网的前缀不是另一个子网的前缀**，利用**哈夫曼编码**
* h是指原始的CIDR地址块当中，可以自由分配的主机号的位数
  * **因为如果只有1位bit进行分配，不是1就是0，而这两个地址是特殊ip地址不能分配给主机，所以一个网络至少2位bit**
* 一个叶子节点和根节点的距离，就是子网中要加多少个bit作为网络前缀

![](/img/webbb.png)

![](/img/bw35.png)

* 路由器直连主机的点对点链路，说明**路由器的接口和主机构成一个最小子网**，**至少需要两个IP地址分配给路由器和主机，除此之外还有广播地址全1和本网络全0，一共四个地址**

##### 回顾

![](/img/dvsvbb.png)

#### 网络地址转换NAT

![](/img/AWG.png)

##### 要点总结

![](/img/EFAFDSAG.png)

![](/img/wqwcq.png)

![](/img/efwqfq.png)

* 外网IP也常被称为公网IP
* 部分IP地址只能作为**私有IP**，并且不同局域网内能**重复**，也就是说**不同局域网内可能出现相同的私有IP地址**

* 发送IP数据报的时候，先发送到连接局域网的路由器接口，然后通过NAT路由器转换为外网IP发送出去
* NAT表记录了**外网IP端口号和内网IP端口号之间的映射关系**，端口号是NAT路由器自己去随机分配的，外网地址是被ISP分配的全球唯一IP

###### 手机1的微信给手机2的微信发一段文字

![](/img/Q3VT43.png)

* ①手机1在微信里面输入文字信息“在吗”？

* ②“在吗“属于应用层数据，应用层会将数据发给传输层，传输层通过TCP协议，在数据前加入TCP首部，TCP首部里面指明源端口号及目的端口号

  * 手机1只知道自己的端口号和手机2通过NAT路由器转换后的**被映射的外网IP地址和端口号**
    * 端口号通过服务器查到的
      * 比如腾讯有个服务器专门服务于微信各个进程，这个服务器的IP地址是固定的，程序员在开发微信的时候可以把这个腾讯服务器的IP地址写到程序里面
        * 这样即使不同手机的IP地址不同，但是他们都能**用一个固定的IP地址找到腾讯的服务器，然后腾讯的服务器告诉他们要找的用户的IP地址和端口号**

  * ③传输层把数据交给网络层，网络层的IPv4协议把数据封装成IP数据报，在首部指明**源IP地址（这台手机自己的内网IP）和目的IP地址（对面手机被映射的外网IP）**
  * ④IP数据报交给数据链路层封装成MAC帧发给默认网关，来到NAT路由器
  * ⑤NAT路由器收到IP数据报之后，需要完成**内网IP端口号和外网IP端口号之间的转换**，查NAT表找到对应表项，修改源IP地址为映射的外网IP地址，源端口转化为映射的外网端口
    * NAT路由器需要包含传输层的功能（修改端口号）
  * ⑥NAT把IP数据报发到外网上，然后通过路由器层层转发到达另一方的NAT路由器，另一方的NAT路由器**根据NAT表进行内外网地址转换，修改目的IP和目的端口号**，转发到内网上，然后根据目的IP地址，到达目的主机
  * ⑦目的主机拆掉IP数据报首部得到传输层数据，根据传输层首部的目的端口号确定应用层的数据属于微信进程，这样手机2的微信收到了”在吗”数据

###### 浏览器进程想给dilidili服务器发送一个数据

![](/img/htwhtnwn.png)

* dilidili服务器上运行了一个web服务器进程，被分配了一个外网IP，没有使用NAT技术

过程：

* ①浏览器准备好了数据，把数据交给传输层的TCP协议，TCP协议添加首部的信息，包含源端口号（2111）和目的端口号（80），交给网络层，网络层封装成IP数据报，包含源IP地址（内网IP）和目的IP地址（dilidili外网IP）
* ②IP数据报发送给默认网关，由于是**内网发向外网，所以NAT路由器需要把源IP地址和源端口映射为外网的IP地址和端口**，接下来把IP数据报发向外网
* ③通过各个路由器层层转发，最后IP数据报会到达外网IP200.1.1.4，**由于这台主机所属的网络没有使用NAT功能，所以这个IP数据报可以根据目的IP地址直接精准送达** 
* ④主机根据这个目的端口号80知道数据是WEB服务器进程来处理的

##### 端口号

![](/img/WECA.png)

* 每一台主机的传输层都可以定义65536个端口
* 每台主机的端口号是独立的

##### 数据的传输过程（垂直视角）

![](/img/2CRQ.png)

##### 如何缓解IP地址不够用的问题

![](/img/CQ23V.png)

* 一个局域网内能承载多个主机，如果说一个局域网内的多个设备可以共享一个IP地址，那么就可以大幅度缓解IP地址不够用的问题
* 如果全球唯一的IP地址结合上一个端口号，让其指向局域网内的某一个特定进程

![](/img/QZ3C.png)

![](/img/3V4VQ44V.png)

### 路由聚合

![](/img/fffwef.png)

* **转发接口相同，部分网络前缀也相同**，将这几条**路由表表项聚合为一条**，叫做路由聚合
  * 路由聚合缩小路由表，使得查询更快
  * 但是会引入一些无效地址
    * 因此如果目的IP地址是无效地址，有可能仍然被转发

#### 最长前缀匹配原则

![](/img/awefg.png)

* 因为G3和铁柱网吧属于同一个子网，所以应该从铁柱网吧子网所对应的IP地址块当中分配一个地址给G3
* **匹配子网前缀更长的优先转发**

#### 大题分析

![](/img/zbwa.png)

![](/img/wecrvev.png)

#### 例

![](/img/wb3baw.png)

* H1给狗剩发送IP数据报的过程：
  * ①源地址是H1的IP地址，目的地址是狗剩的IP地址。
    * H1判断目的地址和自己的IP地址是否属于同一个网络，用子网掩码和本机地址及目的IP地址逐位与，发现不在同一个网络内，需要通过路由器转发到别的网络
  * ②IP数据报发送给默认网关，主机根据ARP协议找到路由器B3接口的MAC地址，MAC帧的目的MAC地址会填入B3接口的MAC地址，然后H1把这个帧交给交换机，交换机根据目的MAC地址交给B3接口
  * ③路由器查询路由表，由于目的IP地址之和默认路由表项匹配，因此IP数据报封装成帧从默认路由接口转发出去
    * 每一个路由器都会用目的IP地址查转发表再从对应接口转发出去，不断重复
  * ④IP数据报到达县路由器，用IP地址和自己的表项对比，从G1接口转发出去到咸鱼电信。
  * ⑤咸鱼电信接收到IP数据报以后开始查路由表，根据匹配表项从对应接口转发出去，最后到达狗剩的主机
* 铁柱给H1发送一个IP数据报的过程：
  * ①源地址是铁柱的IP地址，目的地址是H1的IP地址。
    * 铁柱判断目的地址和自己的IP地址是否属于同一个网络，用子网掩码和本机地址及目的IP地址逐位与，发现不在同一个网络内，需要通过路由器转发到别的网络
  * ②IP数据报发送给默认网关，主机根据ARP协议找到路由器G3接口的MAC地址，MAC帧的目的MAC地址会填入G3接口的MAC地址，然后铁柱把这个帧交给交换机，交换机根据目的MAC地址交给G3接口
  * ③路由器查询路由表，由于目的IP地址之和默认路由表项匹配，因此IP数据报封装成帧从默认路由接口转发出去
    * 每一个路由器都会用目的IP地址查转发表再从对应接口转发出去，不断重复
  * ④IP数据报到达ISP，用IP地址和自己的表项对比，从A2接口转发出去到某学校路由器。
  * ⑤某学校接收到IP数据报以后开始查路由表，根据匹配表项从对应接口转发出去，最后到达H1

### ARP协议

![](/img/23v44532v.png)

#### 各种协议之间的服务关系

![](/img/234v32vb.png)

![](/img/32v45432.png)

![](/img/x234c32v.png)

#### ARP表

![](/img/EWVVEW.png)

#### ARP协议的工作过程

![](/img/23eser.png)

* IP数据报首先要发送给默认网关
  * 目前虽然IP数据报配置了默认网关的IP地址，但没有配置默认网关的MAC地址
* 这种情况下，**H3会构造一个ARP请求分组，指明自己的IP地址，MAC地址和目的IP地址**
* 上面是网络层的PDU，要交给数据链路层并在数据链路层封装成MAC帧
* 因为是广播找人，**MAC帧目的地址全1，源地址是自己的MAC地址**
* MAC帧发给交换机，由于是广播，所以交换机转发到其他所有接口，所有节点都会收到，但只有默认网关收到后不会丢弃
  * 默认网关会顺手把H3的MAC地址和IP地址记录在自己的ARP表中

![](/img/2c3333.png)

* 目的接口会给H3回复一个单播帧，源IP地址是默认网关IP地址，目的IP地址是H3的IP地址，源MAC是默认网关的MAC地址，目的MAC地址是H3的MAC地址
* H3收到ARP响应分组之后，知道所求IP地址和MAC地址之间的映射关系填入ARP表
* **广播找人，单播回复**
* **集线器无脑转发，交换机精准转发**

### DHCP动态主机配置协议

![](/img/webgqwvec.png)

#### DHCP协议的位置

![](/img/rebwwegrwt.png)

![](/img/qwevqrevwq.png)

#### DHCP协议的工作过程

![](/img/34f1f.png)

![](/img/132c.png)

* 为了管理每一个子网当中的这个IP地址资源，通常来说会给每个局域网配置一个DHCP服务器

##### H3新加入网络的过程

![](/img/3c3v3v.png)

* H3本身拥有一个MAC地址，但是没有IP地址、子网掩码、默认网关，因此H3会向DHCP服务器请求给自己分配自己需要的这些东西

* 四个步骤

  * ①**客户（新接入网络的主机）向服务器（DHCP）**发送一个**发现报文**

    * 应用层（DHCP发现报文）：说明自己的**MAC地址**是多少

    * 传输层（UDP数据报）：目的端口号和源端口号

    * 网络层（IP数据报）：源地址尚未分配IP地址，因此全0，刚加入，不知道DHCH服务器地址，目的地址未知，因此广播寻找DHCP服务器

      ![](/img/3qx32.png)

    * 数据链路层（MAC帧）：源地址自己的MAC地址，目的地址全1，广播帧，因为不知道DHCP服务器MAC地址

      * 报文会被广播到网络当中的各个节点，每个节点都会收到，但只有DHCP服务器不会丢弃
        * 因为到达UDP数据报发现目的端口号不匹配

  ![](/img/43v2.png)

  * ②DHCP服务器收到发现报文之后，给主机返回一个**提供报文**
    * 应用层（DHCP提供报文）：说明提供的IP地址，子网掩码，默认网关，租用期
    * 传输层（UDP数据报）：目的端口号和源端口号
    * 网络层（IP数据报）：目的地址H3尚未分配IP地址，因此广播寻找，源地址DHCP服务器
    * 数据链路层（MAC帧）：源地址自己的MAC地址，目的地址从发现报文已知，填H3的MAC地址（**单播帧，精准转发，其他主机收不到**）

  ![](/img/343453245.png)

  * ③客户向服务器发送一个**请求报文**
    * 应用层（DHCP请求报文）：说明自己的**MAC地址**是多少，接受IP地址xxxx
    * 传输层（UDP数据报）：目的端口号和源端口号
    * 网络层（IP数据报）：虽然在走IP地址申请的流程，但是IP地址直到4个报文发送完毕，还不属于H3，因此**源地址全0**，目的地址未知，因为网络中DHCP服务器中可能不止一个，因此可能不止一个DHCP服务器给H3发了IP地址，所以H3要广播告诉网络内的DHCP服务器，自己接收了哪个DHCP服务器分配的IP地址
    * 数据链路层（MAC帧）：源地址自己的MAC地址，目的地址全1，广播帧，理由同IP广播原因

  ![](/img/v432v.png)

  * ④服务器向客户发送一个**确认报文**
    * 应用层（DHCP确认报文）：说明提供的IP地址，子网掩码，默认网关，租用期
    * 传输层（UDP数据报）：目的端口号和源端口号
    * 网络层（IP数据报）：目的地址H3尚未分配IP地址，因此广播寻找，源地址DHCP服务器
    * 数据链路层（MAC帧）：源地址自己的MAC地址，目的地址从发现报文已知，填H3的MAC地址（**单播帧，精准转发，其他主机收不到**）

  ![](/img/2c3423.png)

## 王道基础课传输层内容